{% raw %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteOS å¤šè®¾å¤‡ç›‘æ§ä¸­å¿ƒ</title>
    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: none; margin-bottom: 20px;}
        .sensor-val { font-size: 2.5rem; font-weight: bold; color: #0d6efd; }
        .sensor-unit { font-size: 1rem; color: #6c757d; }
        #chart-container { width: 100%; height: 400px; }
        .bulb-icon { font-size: 3rem; color: #ccc; transition: color 0.3s;}
        .bulb-on { color: #ffc107; }
        .chart-controls { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px;}
        .device-selector { background: #e9ecef; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <h2 class="text-center mb-4">LiteOS å¤šè®¾å¤‡ç›‘æ§å¤§å±</h2>

        <div class="device-selector d-flex align-items-center justify-content-center gap-3">
            <label class="fw-bold">ğŸ‘‰ é€‰æ‹©è¦ç›‘æ§çš„è®¾å¤‡:</label>
            <select class="form-select w-auto" v-model="currentDeviceId" @change="handleDeviceChange">
                <option v-for="(data, devId) in devices" :value="devId" :key="devId">
                    {{ devId }} ({{ data.light_on ? 'ç¯äº®' : 'ç¯ç­' }})
                </option>
            </select>
            <span v-if="Object.keys(devices).length === 0" class="text-danger">
                æš‚æ— è®¾å¤‡åœ¨çº¿ (è¯·æ£€æŸ¥å¼€å‘æ¿æ˜¯å¦å·²è¿æ¥ WiFi å¹¶å‘é€æ•°æ®)
            </span>
        </div>

        <div v-if="currentDeviceId && devices[currentDeviceId]" class="row">
            <div class="col-md-4">
                <div class="card text-center p-3">
                    <h5>å®æ—¶æ¸©åº¦</h5>
                    <div>
                        <span class="sensor-val">{{ devices[currentDeviceId].temperature.toFixed(1) }}</span>
                        <span class="sensor-unit">â„ƒ</span>
                    </div>
                </div>
                <div class="card text-center p-3">
                    <h5>å®æ—¶æ¹¿åº¦</h5>
                    <div>
                        <span class="sensor-val">{{ devices[currentDeviceId].humidity.toFixed(1) }}</span>
                        <span class="sensor-unit">%</span>
                    </div>
                </div>
                <div class="card text-center p-3">
                    <h5>è®¾å¤‡æ§åˆ¶ ({{ currentDeviceId }})</h5>
                    <div class="mb-3">
                        <i class="bulb-icon" :class="{ 'bulb-on': devices[currentDeviceId].light_on }">ğŸ’¡</i>
                    </div>
                    <button class="btn btn-lg w-100" 
                        :class="devices[currentDeviceId].light_on ? 'btn-danger' : 'btn-success'" 
                        @click="toggleLight" :disabled="isLoading">
                        {{ devices[currentDeviceId].light_on ? 'å…³é—­ç¯å…‰' : 'å¼€å¯ç¯å…‰' }}
                    </button>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0">æ•°æ®è¶‹åŠ¿ ({{ currentDeviceId }})</h5>
                    </div>

                    <div class="chart-controls border">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="modeRealtime" value="realtime" v-model="viewMode" @change="handleModeChange">
                            <label class="form-check-label" for="modeRealtime">å®æ—¶ç›‘æ§</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="modeHistory" value="history" v-model="viewMode" @change="handleModeChange">
                            <label class="form-check-label" for="modeHistory">å†å²å›æ”¾</label>
                        </div>
                        
                        <div v-if="viewMode === 'history'" class="d-flex gap-2">
                            <input type="date" class="form-control form-control-sm" v-model="selectedDate">
                            <button class="btn btn-sm btn-primary" @click="fetchHistoryData">æŸ¥è¯¢</button>
                        </div>
                    </div>

                    <div id="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/vue.js"></script>
    <script src="/static/js/axios.js"></script>
    <script src="/static/js/echarts.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    devices: {},
                    currentDeviceId: "",
                    isLoading: false,
                    chartInstance: null,
                    chartDataTime: [],
                    chartDataTemp: [],
                    timer: null,
                    viewMode: 'realtime',
                    selectedDate: new Date().toISOString().split('T')[0]
                }
            },
            mounted() {
                // åˆ é™¤è¿™é‡Œçš„ this.initChart(); å› ä¸ºæ­¤æ—¶ DOM å¯èƒ½è¿˜æ²¡å‡†å¤‡å¥½
                this.startPolling();
                
                // çª—å£å¤§å°æ”¹å˜æ—¶è‡ªåŠ¨è°ƒæ•´å›¾è¡¨å¤§å°
                window.addEventListener('resize', () => {
                    if (this.chartInstance) {
                        this.chartInstance.resize();
                    }
                });
            },
            // --- ã€æ ¸å¿ƒä¿®å¤ã€‘æ–°å¢ watch ç›‘å¬ ---
            watch: {
                // ç›‘å¬å½“å‰é€‰ä¸­çš„è®¾å¤‡ID
                currentDeviceId(newVal) {
                    // å¦‚æœæœ‰äº†è®¾å¤‡IDï¼Œä¸”å›¾è¡¨è¿˜æ²¡åˆå§‹åŒ–
                    if (newVal && !this.chartInstance) {
                        // $nextTick çš„æ„æ€æ˜¯ï¼šç­‰ Vue æŠŠç•Œé¢ç”»å¥½ä¹‹åï¼Œå†æ‰§è¡Œé‡Œé¢çš„ä»£ç 
                        this.$nextTick(() => {
                            this.initChart();
                        });
                    }
                }
            },
            // -------------------------------
            methods: {
                initChart() {
                    const chartDom = document.getElementById('chart-container');
                    // å¦‚æœè¿˜æ‰¾ä¸åˆ° DOMï¼Œè¯´æ˜æ—¶æœºä¸å¯¹ï¼Œç›´æ¥è¿”å›
                    if(!chartDom) return;
                    
                    // é”€æ¯æ—§å®ä¾‹ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
                    if(this.chartInstance != null && this.chartInstance != "" && this.chartInstance != undefined) {
                        this.chartInstance.dispose();
                    }

                    this.chartInstance = echarts.init(chartDom);
                    const option = {
                        title: { text: 'æ•°æ®åŠ è½½ä¸­...', left: 'center' },
                        tooltip: { trigger: 'axis' },
                        grid: { left: '3%', right: '8%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', data: [] },
                        yAxis: { type: 'value', name: 'æ¸©åº¦(â„ƒ)', scale: true },
                        series: [{
                            data: [],
                            type: 'line', 
                            smooth: true,
                            itemStyle: { color: '#0d6efd' },
                            areaStyle: { color: 'rgba(13, 110, 253, 0.1)' }
                        }]
                    };
                    this.chartInstance.setOption(option);
                },

                startPolling() {
                    this.fetchDevices();
                    this.timer = setInterval(this.fetchDevices, 1000);
                },

                fetchDevices() {
                    axios.get('/api/devices').then(res => {
                        this.devices = res.data;
                        const ids = Object.keys(this.devices);
                        
                        if (!this.currentDeviceId && ids.length > 0) {
                            this.currentDeviceId = ids[0];
                            this.chartDataTime = [];
                            this.chartDataTemp = [];
                            // è¿™é‡Œæ”¹å˜ currentDeviceId ä¼šè§¦å‘ä¸Šé¢çš„ watch -> initChart
                        }

                        if (this.currentDeviceId && this.viewMode === 'realtime') {
                            this.updateRealtimeChart();
                        }
                    }).catch(err => console.error("APIè¯·æ±‚å¤±è´¥:", err));
                },

                updateRealtimeChart() {
                    // ã€å®‰å…¨æ£€æŸ¥ã€‘å¦‚æœå›¾è¡¨è¿˜æ²¡åˆå§‹åŒ–æˆåŠŸï¼Œå°±ä¸è¦æ›´æ–°ï¼Œé˜²æ­¢æŠ¥é”™
                    if (!this.chartInstance) return;

                    const currentData = this.devices[this.currentDeviceId];
                    if (!currentData) return;

                    const now = new Date().toLocaleTimeString();
                    if (this.chartDataTime.length > 0 && this.chartDataTime[this.chartDataTime.length - 1] === now) {
                        return; 
                    }

                    this.chartDataTime.push(now);
                    this.chartDataTemp.push(currentData.temperature);

                    if (this.chartDataTime.length > 60) {
                        this.chartDataTime.shift();
                        this.chartDataTemp.shift();
                    }
                    
                    this.chartInstance.setOption({
                        title: { text: this.currentDeviceId + ' å®æ—¶ç›‘æ§' },
                        xAxis: { data: this.chartDataTime },
                        series: [{ data: this.chartDataTemp }]
                    });
                },

                handleDeviceChange() {
                    this.chartDataTime = [];
                    this.chartDataTemp = [];
                    this.viewMode = 'realtime';
                    if (this.chartInstance) {
                        this.chartInstance.setOption({
                            title: { text: 'åˆ‡æ¢è®¾å¤‡ä¸­...' },
                            xAxis: { data: [] }, series: [{ data: [] }] 
                        });
                    }
                },

                fetchHistoryData() {
                    if (!this.currentDeviceId || !this.chartInstance) return;
                    
                    this.chartInstance.showLoading();
                    axios.get('/api/history', { 
                        params: { 
                            date: this.selectedDate,
                            device_id: this.currentDeviceId 
                        } 
                    })
                    .then(res => {
                        this.chartInstance.hideLoading();
                        const times = res.data.times;
                        const temps = res.data.temps;
                        
                        if (!times || times.length === 0) {
                            alert("è¯¥è®¾å¤‡åœ¨ " + this.selectedDate + " æ²¡æœ‰å†å²æ•°æ®");
                            return;
                        }
                        this.chartInstance.setOption({
                            title: { text: `${this.currentDeviceId} - ${this.selectedDate} å†å²å›æ”¾` },
                            xAxis: { data: times },
                            series: [{ data: temps }]
                        });
                    }).catch(err => {
                        this.chartInstance.hideLoading();
                        console.error(err);
                        alert("æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—");
                    });
                },

                handleModeChange() {
                    if (this.viewMode === 'realtime') {
                        this.chartDataTime = [];
                        this.chartDataTemp = [];
                    }
                },

                toggleLight() {
                    if (!this.currentDeviceId) return;
                    this.isLoading = true;
                    
                    const currentStatus = this.devices[this.currentDeviceId].light_on;
                    const targetAction = currentStatus ? 'off' : 'on';
                    
                    axios.post('/api/control', { 
                        device_id: this.currentDeviceId, 
                        action: targetAction 
                    })
                    .then(res => {
                        console.log("æ§åˆ¶æŒ‡ä»¤å·²å‘é€");
                    })
                    .catch(err => {
                        alert("æ§åˆ¶å¤±è´¥: " + err);
                    })
                    .finally(() => {
                        setTimeout(() => this.isLoading = false, 500);
                    });
                }
            }
        }).mount('#app');
    </script>
</html>
{% endraw %}